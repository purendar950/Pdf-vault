<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Vault</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&family=Instrument+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --ink: #080810;
  --deep: #0e0e1a;
  --surface: #141422;
  --card: #1a1a2e;
  --lift: #202038;
  --edge: rgba(255,255,255,0.06);
  --edge2: rgba(255,255,255,0.1);
  --amber: #f0a500;
  --amber-dim: rgba(240,165,0,0.12);
  --amber-glow: rgba(240,165,0,0.25);
  --sky: #4fc3f7;
  --text: #e8e8f8;
  --sub: #8888aa;
  --danger: #ff5c5c;
  --ok: #4ade80;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--ink);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* grain */
body::after {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='g'%3E%3CfeTurbulence baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='1'/%3E%3C/svg%3E");
  opacity: 0.03;
}

/* â”€â”€ SCREENS â”€â”€ */
.screen { display: none; min-height: 100vh; flex-direction: column; }
.screen.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth {
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  background:
    radial-gradient(ellipse 60% 40% at 20% 10%, rgba(240,165,0,0.06) 0%, transparent 70%),
    radial-gradient(ellipse 50% 50% at 85% 90%, rgba(79,195,247,0.04) 0%, transparent 70%),
    var(--ink);
}

.brand {
  text-align: center;
  margin-bottom: 2.5rem;
  animation: rise 0.7s cubic-bezier(.22,1,.36,1) both;
}

.brand-mark {
  display: inline-flex;
  width: 72px; height: 72px;
  border-radius: 18px;
  background: linear-gradient(135deg, var(--amber-dim), rgba(240,165,0,0.03));
  border: 1px solid rgba(240,165,0,0.2);
  align-items: center; justify-content: center;
  font-size: 2rem;
  margin-bottom: 1.25rem;
  box-shadow: 0 0 40px rgba(240,165,0,0.1), inset 0 1px 0 rgba(255,255,255,0.05);
}

.brand h1 {
  font-family: 'Syne', sans-serif;
  font-size: 2.5rem;
  font-weight: 800;
  letter-spacing: -1px;
  line-height: 1;
}
.brand h1 em { font-style: normal; color: var(--amber); }

.brand p {
  color: var(--sub);
  font-size: 0.8rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  margin-top: 0.6rem;
}

/* config notice */
.worker-notice {
  background: rgba(240,165,0,0.08);
  border: 1px solid rgba(240,165,0,0.2);
  border-radius: 10px;
  padding: 0.75rem 1rem;
  font-size: 0.78rem;
  color: #c8a040;
  margin-bottom: 1.25rem;
  font-family: 'JetBrains Mono', monospace;
  display: flex; align-items: center; gap: 0.6rem;
  display: none; /* shown when WORKER_URL not set */
}

.glass {
  background: var(--surface);
  border: 1px solid var(--edge2);
  border-radius: 20px;
  padding: 2rem;
  width: 100%; max-width: 440px;
  box-shadow:
    0 32px 80px rgba(0,0,0,0.5),
    0 0 0 1px var(--edge),
    inset 0 1px 0 rgba(255,255,255,0.04);
  animation: rise 0.7s 0.08s cubic-bezier(.22,1,.36,1) both;
}

/* tabs */
.tabs {
  display: flex;
  background: var(--deep);
  border-radius: 12px;
  padding: 3px;
  margin-bottom: 1.75rem;
  border: 1px solid var(--edge);
}
.tab {
  flex: 1; padding: 0.6rem;
  border: none; border-radius: 9px;
  background: transparent; color: var(--sub);
  font-family: 'Instrument Sans', sans-serif;
  font-size: 0.82rem; font-weight: 500;
  cursor: pointer; transition: all 0.2s;
}
.tab.on {
  background: var(--card);
  color: var(--amber);
  border: 1px solid rgba(240,165,0,0.15);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.err-box {
  background: rgba(255,92,92,0.08);
  border: 1px solid rgba(255,92,92,0.25);
  border-radius: 10px; padding: 0.7rem 1rem;
  font-size: 0.82rem; color: var(--danger);
  margin-bottom: 1rem; display: none;
}

.panel { display: none; }
.panel.on { display: block; }

/* fields */
.f { margin-bottom: 1.1rem; }
.f label {
  display: block; font-size: 0.7rem;
  color: var(--sub); letter-spacing: 2px;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 0.45rem;
}
.f input {
  width: 100%; padding: 0.8rem 1rem;
  background: var(--deep); border: 1px solid var(--edge2);
  border-radius: 10px; color: var(--text);
  font-size: 0.9rem; font-family: 'JetBrains Mono', monospace;
  outline: none; transition: all 0.2s;
}
.f input:focus {
  border-color: rgba(240,165,0,0.35);
  box-shadow: 0 0 0 3px rgba(240,165,0,0.07);
}
.f input::placeholder { color: #30304a; }

.hint {
  font-size: 0.72rem; color: var(--sub);
  margin-top: 0.35rem; line-height: 1.5;
}

/* big button */
.cta {
  width: 100%; padding: 0.95rem;
  background: linear-gradient(135deg, #c88800, var(--amber));
  border: none; border-radius: 12px;
  color: #0a0800; font-weight: 700; font-size: 0.9rem;
  font-family: 'Syne', sans-serif; letter-spacing: 0.3px;
  cursor: pointer; transition: all 0.2s;
  position: relative; overflow: hidden; margin-top: 0.25rem;
}
.cta::after {
  content: '';
  position: absolute; top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}
.cta:hover::after { left: 100%; }
.cta:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(240,165,0,0.3); }
.cta:active { transform: translateY(0); }
.cta:disabled { opacity: 0.45; cursor: not-allowed; }
.cta:disabled::after { display: none; }

.sep {
  display: flex; align-items: center; gap: 0.75rem;
  color: var(--sub); font-size: 0.75rem; margin: 1.25rem 0;
}
.sep::before, .sep::after {
  content: ''; flex: 1; height: 1px; background: var(--edge2);
}

.info-row {
  font-size: 0.75rem; color: var(--sub);
  text-align: center; line-height: 1.6;
}
.info-row strong { color: var(--text); }


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VAULT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#vault { background: var(--ink); }

.nav {
  height: 60px;
  background: rgba(14,14,26,0.95);
  border-bottom: 1px solid var(--edge2);
  display: flex; align-items: center; gap: 1rem;
  padding: 0 1.5rem;
  position: sticky; top: 0; z-index: 100;
  backdrop-filter: blur(16px);
}

.nav-brand {
  font-family: 'Syne', sans-serif; font-size: 1.15rem;
  font-weight: 800; color: var(--text); letter-spacing: -0.5px;
  flex-shrink: 0;
}
.nav-brand span { color: var(--amber); }

.code-pill {
  display: flex; align-items: center; gap: 0.4rem;
  background: var(--amber-dim); border: 1px solid rgba(240,165,0,0.18);
  border-radius: 8px; padding: 0.28rem 0.7rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
  color: var(--amber); cursor: pointer; flex-shrink: 0;
  transition: background 0.2s;
}
.code-pill:hover { background: rgba(240,165,0,0.18); }

.nav-search {
  flex: 1; max-width: 360px;
  margin-left: auto; position: relative;
}
.nav-search input {
  width: 100%; padding: 0.45rem 1rem 0.45rem 2.2rem;
  background: var(--surface); border: 1px solid var(--edge);
  border-radius: 8px; color: var(--text); font-size: 0.83rem;
  font-family: 'Instrument Sans', sans-serif;
  outline: none; transition: border-color 0.2s;
}
.nav-search input:focus { border-color: rgba(240,165,0,0.3); }
.nav-search::before {
  content: 'âŒ•'; position: absolute;
  left: 0.65rem; top: 50%; transform: translateY(-50%);
  color: var(--sub); font-size: 0.95rem; pointer-events: none;
}

.nav-btn {
  padding: 0.42rem 1rem; border-radius: 8px;
  border: 1px solid rgba(240,165,0,0.4); background: transparent;
  color: var(--amber); font-size: 0.8rem;
  font-family: 'Instrument Sans', sans-serif;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
  flex-shrink: 0;
}
.nav-btn:hover { background: var(--amber-dim); }
.nav-btn.ghost { border-color: var(--edge); color: var(--sub); }
.nav-btn.ghost:hover { border-color: var(--danger); color: var(--danger); background: rgba(255,92,92,0.07); }

/* content */
.main { flex: 1; padding: 2rem 1.5rem; max-width: 1300px; margin: 0 auto; width: 100%; }

.status-bar {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.6rem 1rem;
  background: var(--surface); border: 1px solid var(--edge);
  border-radius: 10px; font-size: 0.77rem;
  font-family: 'JetBrains Mono', monospace; margin-bottom: 1.75rem;
}
.dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--ok); flex-shrink: 0;
}
.dot.spin { background: var(--amber); animation: pulse 1.2s ease infinite; }
.dot.bad { background: var(--danger); animation: none; }
.status-msg { color: var(--sub); }
.status-msg b { color: var(--text); }
.status-right { margin-left: auto; color: #555570; }

.section-head {
  display: flex; align-items: flex-end;
  justify-content: space-between; margin-bottom: 1.5rem;
}
.section-head h2 {
  font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 700;
}
.section-head h2 small {
  display: block; font-family: 'Instrument Sans', sans-serif;
  font-size: 0.78rem; font-weight: 400; color: var(--sub); margin-bottom: 0.2rem;
}

.view-tog { display: flex; gap: 0.4rem; }
.vtb {
  width: 34px; height: 34px; border: 1px solid var(--edge);
  border-radius: 7px; background: transparent;
  color: var(--sub); cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.vtb.on { background: var(--amber-dim); border-color: rgba(240,165,0,0.25); color: var(--amber); }

/* UPLOAD zone */
.dropzone {
  border: 2px dashed var(--edge2);
  border-radius: 16px; padding: 2.5rem;
  text-align: center; margin-bottom: 1.75rem;
  cursor: pointer; transition: all 0.25s;
  position: relative;
}
.dropzone:hover, .dropzone.over {
  border-color: rgba(240,165,0,0.4);
  background: rgba(240,165,0,0.02);
}
.dropzone-icon { font-size: 2.2rem; opacity: 0.5; margin-bottom: 0.6rem; }
.dropzone p { color: var(--sub); font-size: 0.85rem; }
.dropzone strong { color: var(--amber); }
#file-in { display: none; }

/* PROGRESS */
.prog-wrap { display: none; margin-bottom: 1.25rem; }
.prog-track { height: 3px; background: var(--edge); border-radius: 2px; overflow: hidden; margin-bottom: 0.4rem; }
.prog-fill {
  height: 100%;
  background: linear-gradient(90deg, #c88800, var(--amber), #ffe066);
  background-size: 200%;
  animation: shimmer 1.5s linear infinite;
  border-radius: 2px; transition: width 0.3s; width: 0%;
}
@keyframes shimmer { from { background-position: 200% } to { background-position: -200% } }
.prog-text { font-size: 0.73rem; color: var(--sub); font-family: 'JetBrains Mono', monospace; }

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap: 1.1rem;
}
.grid.list { grid-template-columns: 1fr; }

.card {
  background: var(--card);
  border: 1px solid var(--edge);
  border-radius: 14px; overflow: hidden;
  cursor: pointer; transition: all 0.22s;
  animation: rise 0.4s cubic-bezier(.22,1,.36,1) both;
}
.card:hover {
  border-color: rgba(240,165,0,0.25);
  transform: translateY(-3px);
  box-shadow: 0 14px 40px rgba(0,0,0,0.4), 0 0 20px rgba(240,165,0,0.06);
}

.thumb {
  height: 150px;
  background: linear-gradient(135deg, #1a1a2a, #0f0f1c);
  display: flex; align-items: center; justify-content: center;
  font-size: 3rem; color: var(--sub);
  position: relative; overflow: hidden;
}
.thumb::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
  background: linear-gradient(transparent, var(--card));
}

.card-body { padding: 0.9rem; }
.card-name {
  font-size: 0.82rem; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 0.25rem;
}
.card-meta {
  font-size: 0.7rem; color: var(--sub);
  font-family: 'JetBrains Mono', monospace;
}

.card-actions {
  display: flex; gap: 0.4rem;
  padding: 0.6rem 0.9rem;
  border-top: 1px solid var(--edge);
}
.act {
  flex: 1; padding: 0.35rem;
  border: 1px solid var(--edge); border-radius: 6px;
  background: transparent; color: var(--sub);
  font-size: 0.72rem; cursor: pointer; transition: all 0.18s;
  font-family: 'Instrument Sans', sans-serif;
}
.act:hover { background: rgba(255,255,255,0.04); color: var(--text); }
.act.rm:hover { border-color: var(--danger); color: var(--danger); background: rgba(255,92,92,0.07); }

/* list mode */
.grid.list .card { display: flex; align-items: center; }
.grid.list .thumb { width: 72px; height: 64px; flex-shrink: 0; font-size: 1.6rem; border-radius: 0; }
.grid.list .card-body { flex: 1; padding: 0.75rem; }
.grid.list .card-actions { border-top: none; border-left: 1px solid var(--edge); flex-direction: column; width: 90px; }

/* empty */
.empty {
  text-align: center; padding: 5rem 1rem;
  color: var(--sub);
}
.folder-bar {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0 0 0.75rem 0; flex-wrap: wrap;
}
.breadcrumb {
  display: flex; align-items: center; gap: 0.3rem;
  font-size: 0.78rem; color: var(--sub); flex: 1;
  font-family: 'JetBrains Mono', monospace;
}
.breadcrumb span { cursor: pointer; }
.breadcrumb span:hover { color: var(--amber); }
.breadcrumb .sep { opacity: 0.4; cursor: default; }
.breadcrumb .cur { color: var(--text); cursor: default; }
.btn-folder {
  padding: 0.4rem 0.85rem; font-size: 0.75rem;
  background: var(--lift); border: 1px solid var(--edge2);
  border-radius: 8px; color: var(--sub); cursor: pointer;
  font-family: 'Instrument Sans', sans-serif; transition: all 0.2s;
  white-space: nowrap;
}
.btn-folder:hover { border-color: var(--amber); color: var(--amber); }
.folder-card {
  background: var(--card); border: 1px solid var(--edge2);
  border-radius: 14px; padding: 1rem 1.25rem;
  display: flex; align-items: center; gap: 0.85rem;
  cursor: pointer; transition: all 0.18s; animation: cardIn 0.35s both;
}
.folder-card:hover { border-color: rgba(240,165,0,0.3); transform: translateY(-1px); }
.folder-icon { font-size: 1.6rem; flex-shrink: 0; }
.folder-name { font-size: 0.88rem; font-weight: 500; }
.folder-meta { font-size: 0.72rem; color: var(--sub); margin-top: 0.1rem; }
.folder-del {
  margin-left: auto; background: none; border: none;
  color: var(--sub); cursor: pointer; font-size: 0.8rem; padding: 0.2rem 0.4rem;
  border-radius: 5px; opacity: 0;  transition: all 0.15s;
}
.folder-card:hover .folder-del { opacity: 1; }
.folder-del:hover { color: var(--danger); background: rgba(255,92,92,0.1); }

.empty h3 { font-family: 'Syne', sans-serif; font-size: 1.3rem; opacity: 0.35; color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#viewer { background: #050508; }

.vbar {
  height: 54px;
  background: var(--deep);
  border-bottom: 1px solid var(--edge);
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0 1.25rem;
  position: sticky; top: 0; z-index: 100;
}

.back {
  padding: 0.35rem 0.8rem;
  border: 1px solid var(--edge); border-radius: 7px;
  background: transparent; color: var(--sub);
  font-size: 0.78rem; cursor: pointer;
  font-family: 'Instrument Sans', sans-serif;
  transition: all 0.2s; flex-shrink: 0;
}
.back:hover { color: var(--text); border-color: var(--edge2); }

.vtitle {
  flex: 1; font-size: 0.85rem; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin: 0 0.75rem;
}

.pgctrl {
  display: flex; align-items: center; gap: 0.4rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.76rem;
}
.pgbtn {
  width: 30px; height: 30px; border: 1px solid var(--edge);
  border-radius: 6px; background: transparent; color: var(--text);
  cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.pgbtn:hover { background: rgba(255,255,255,0.05); }
.pgbtn:disabled { opacity: 0.25; cursor: default; }
.pginput {
  width: 44px; padding: 0.28rem 0.4rem;
  background: var(--surface); border: 1px solid var(--edge);
  border-radius: 6px; color: var(--text); font-size: 0.76rem;
  font-family: 'JetBrains Mono', monospace; text-align: center; outline: none;
}

.zctrl {
  display: flex; align-items: center; gap: 0.4rem;
  margin-left: 0.4rem;
}
.zlabel {
  font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
  color: var(--sub); min-width: 38px; text-align: center;
}

.dl-btn {
  padding: 0.35rem 0.8rem;
  border: 1px solid rgba(240,165,0,0.35); border-radius: 7px;
  background: var(--amber-dim); color: var(--amber);
  font-size: 0.78rem; cursor: pointer;
  font-family: 'Instrument Sans', sans-serif;
  transition: all 0.2s; margin-left: 0.4rem; flex-shrink: 0;
}
.dl-btn:hover { background: rgba(240,165,0,0.18); }

.vwrap {
  flex: 1; overflow-y: auto;
  display: flex; flex-direction: column;
  align-items: center; padding: 2rem 1rem; gap: 1.25rem;
}

.vloading {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  flex: 1; color: var(--sub); gap: 1rem;
}
.spin-ring {
  width: 36px; height: 36px;
  border: 2px solid var(--edge); border-top-color: var(--amber);
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
.page-wrap {
  box-shadow: 0 8px 40px rgba(0,0,0,0.7);
  border-radius: 3px; overflow: hidden;
}
.page-wrap canvas { display: block; max-width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(5px);
  display: none; align-items: center; justify-content: center; padding: 1rem;
}
.overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--edge2);
  border-radius: 20px; padding: 2rem;
  max-width: 440px; width: 100%;
  box-shadow: 0 40px 100px rgba(0,0,0,0.7);
  animation: rise 0.28s cubic-bezier(.22,1,.36,1);
}
.modal h3 { font-family: 'Syne', sans-serif; font-size: 1.3rem; margin-bottom: 0.6rem; }
.modal p { color: var(--sub); font-size: 0.84rem; line-height: 1.6; }
.modal-btns { display: flex; gap: 0.6rem; justify-content: flex-end; margin-top: 1.5rem; }
.btn-can {
  padding: 0.55rem 1.1rem; border: 1px solid var(--edge); border-radius: 8px;
  background: transparent; color: var(--sub); cursor: pointer; font-size: 0.83rem;
  font-family: 'Instrument Sans', sans-serif; transition: all 0.2s;
}
.btn-can:hover { color: var(--text); }
.btn-del {
  padding: 0.55rem 1.1rem; border: none; border-radius: 8px;
  background: var(--danger); color: white; cursor: pointer; font-size: 0.83rem;
  font-family: 'Instrument Sans', sans-serif; transition: all 0.2s;
}
.btn-del:hover { background: #e04040; }

/* code box */
.code-reveal {
  background: var(--deep); border: 1px solid rgba(240,165,0,0.25);
  border-radius: 12px; padding: 1.25rem 1rem;
  text-align: center; margin: 1rem 0;
}
.code-reveal .code {
  font-family: 'JetBrains Mono', monospace; font-size: 1.4rem;
  letter-spacing: 3px; color: var(--amber); word-break: break-all;
}
.code-reveal .codesub { font-size: 0.72rem; color: var(--sub); margin-top: 0.5rem; }
.code-copy-btn {
  margin-top: 0.75rem; padding: 0.45rem 1.2rem;
  border: 1px solid rgba(240,165,0,0.3); border-radius: 8px;
  background: var(--amber-dim); color: var(--amber);
  font-size: 0.8rem; cursor: pointer;
  font-family: 'Instrument Sans', sans-serif; transition: all 0.2s;
}
.code-copy-btn:hover { background: rgba(240,165,0,0.18); }

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#toasts {
  position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9998;
  display: flex; flex-direction: column; gap: 0.6rem;
}
.toast {
  background: var(--card); border: 1px solid var(--edge2);
  border-radius: 12px; padding: 0.85rem 1.1rem;
  font-size: 0.82rem; max-width: 300px;
  display: flex; align-items: center; gap: 0.6rem;
  animation: slideRight 0.3s ease;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.toast.ok { border-color: rgba(74,222,128,0.3); }
.toast.bad { border-color: rgba(255,92,92,0.3); }

/* â”€â”€â”€ KEYFRAMES â”€â”€â”€ */
@keyframes rise {
  from { opacity: 0; transform: translateY(18px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideRight {
  from { opacity: 0; transform: translateX(18px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; transform: scale(0.85); }
}

/* scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--deep); }
::-webkit-scrollbar-thumb { background: var(--lift); border-radius: 3px; }

/* responsive */
@media (max-width: 600px) {
  .nav { padding: 0 1rem; gap: 0.6rem; }
  .nav-search { max-width: 130px; }
  .main { padding: 1.25rem 1rem; }
  .zctrl { display: none; }
  .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
  .vbar { padding: 0 0.75rem; gap: 0.4rem; }
}
</style>
</head>
<body>

<!-- â”€â”€ TOASTS â”€â”€ -->
<div id="toasts"></div>

<!-- â”€â”€ DELETE CONFIRM â”€â”€ -->
<div class="overlay" id="del-modal">
  <div class="modal">
    <h3>Delete File?</h3>
    <p>Permanently remove "<span id="del-name"></span>" from your vault. This cannot be undone.</p>
    <div class="modal-btns">
      <button class="btn-can" onclick="closeDelModal()">Cancel</button>
      <button class="btn-del" onclick="confirmDel()">Delete</button>
    </div>
  </div>
</div>

<!-- â”€â”€ VAULT CODE MODAL â”€â”€ -->
<div class="overlay" id="code-modal">
  <div class="modal">
    <h3>ğŸ” Vault Created!</h3>
    <p>This is your unique vault code. Save it â€” you'll need it to access your vault from any device.</p>
    <div class="code-reveal">
      <div class="code" id="show-code">----</div>
      <div class="codesub">Your private vault identifier</div>
      <button class="code-copy-btn" onclick="copyCode()">Copy Code</button>
    </div>
    <p style="font-size:0.73rem; margin-top:0.75rem; color:#666680">âš ï¸ We never store this code. If you lose it, the vault becomes inaccessible.</p>
    <div class="modal-btns">
      <button class="cta" style="width:auto; padding:0.55rem 1.5rem; font-size:0.85rem;" onclick="enterVault()">Enter My Vault â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="auth">
  <div class="brand">
    <div class="brand-mark">ğŸ›ï¸</div>
    <h1>File <em>Vault</em></h1>
    <p>Secure Cloud Library</p>
  </div>

  <div class="glass">
    <div id="worker-notice" class="worker-notice">
      âš  Worker URL not configured â€” see setup guide
    </div>

    <div class="tabs">
      <button class="tab on" onclick="switchTab('new')">Create Vault</button>
      <button class="tab" onclick="switchTab('open')">Access Vault</button>
    </div>

    <div id="err-box" class="err-box"></div>

    <!-- CREATE -->
    <div class="panel on" id="panel-new">
      <div class="f">
        <label>Vault Name <span style="opacity:.5">(optional)</span></label>
        <input id="vault-name" type="text" placeholder="My Documents" maxlength="50">
      </div>
      <button class="cta" id="btn-create" onclick="createVault()">
        Create My Vault
      </button>
      <div class="sep">How it works</div>
      <div class="info-row">
        A <strong>private vault</strong> is created for you.<br>
        You'll get a unique <strong>vault code</strong> â€” that's your only key.<br>
        No account or password needed.
      </div>
    </div>

    <!-- OPEN -->
    <div class="panel" id="panel-open">
      <div class="f">
        <label>Vault Code</label>
        <input id="vault-code-in" type="text" placeholder="XXXX-XXXX-XXXX-XXXX"
               style="letter-spacing:2px; text-transform:uppercase"
               autocomplete="off" spellcheck="false">
        <div class="hint">Enter the code you received when creating your vault</div>
      </div>
      <button class="cta" id="btn-open" onclick="openVault()">
        Open Vault
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• VAULT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="vault">
  <nav class="nav">
    <div class="nav-brand">File<span>Vault</span></div>
    <div class="code-pill" onclick="showCodeModal()" title="Click to copy vault code">
      ğŸ”‘ <span id="pill-code">â€”</span>
    </div>
    <div class="nav-search">
      <input type="text" placeholder="Search filesâ€¦" id="search-in" oninput="filterPDFs()">
    </div>
    <button class="nav-btn" onclick="document.getElementById('file-in').click()">+ Upload</button>
    <button class="nav-btn" onclick="doSync()" id="sync-btn">âŸ³ Sync</button>
    <button class="nav-btn ghost" onclick="logout()">Sign out</button>
  </nav>

  <div class="main">
    <div class="status-bar">
      <div class="dot" id="st-dot"></div>
      <div class="status-msg" id="st-msg">Ready</div>
      <div class="status-right" id="st-count"></div>
    </div>

    <div class="prog-wrap" id="prog-wrap">
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
      <div class="prog-text" id="prog-text">Uploadingâ€¦</div>
    </div>

    <div class="section-head">
      <h2><small id="vault-name-disp">Your Vault</small>My Documents</h2>
      <div class="view-tog">
        <button class="vtb on" id="vbg" onclick="setView('grid')" title="Grid">âŠ</button>
        <button class="vtb" id="vbl" onclick="setView('list')" title="List">â‰¡</button>
      </div>
    </div>

    <div class="folder-bar">
      <div class="breadcrumb" id="breadcrumb">
        <span onclick="goRoot()">ğŸ  Root</span>
      </div>
      <button class="btn-folder" onclick="openFolderModal()">ğŸ“ New Folder</button>
    </div>

    <div class="dropzone" id="dropzone" onclick="document.getElementById('file-in').click()">
      <div class="dropzone-icon">ğŸ“„</div>
      <p><strong>Drop any file here</strong> or click to browse</p>
      <p style="font-size:.75rem; margin-top:.3rem">Any file type Â· Stored securely in the cloud</p>
    </div>
    <input type="file" id="file-in" multiple>

    <div class="grid" id="g"></div>
    <div class="empty" id="empty-state" style="display:none">
      <div class="empty-ico">ğŸ“‚</div>
      <h3>Vault is empty</h3>
      <p style="margin-top:.4rem">Create a folder or upload files to get started</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• VIEWER â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="viewer">
  <div class="vbar">
    <button class="back" onclick="closeViewer()">â† Back</button>
    <div class="vtitle" id="v-title">Document</div>
    <div class="pgctrl">
      <button class="pgbtn" id="pg-prev" onclick="pageStep(-1)">â€¹</button>
      <input class="pginput" type="number" id="pg-in" min="1" onchange="goPage(this.value)">
      <span style="color:var(--sub); font-size:.75rem">/ <span id="pg-tot">1</span></span>
      <button class="pgbtn" id="pg-next" onclick="pageStep(1)">â€º</button>
    </div>
    <div class="zctrl">
      <button class="pgbtn" onclick="zoom(-0.2)" title="Zoom out">âˆ’</button>
      <span class="zlabel" id="z-label">100%</span>
      <button class="pgbtn" onclick="zoom(0.2)" title="Zoom in">+</button>
    </div>
    <button class="dl-btn" onclick="dlCurrent()">â†“ Save</button>
  </div>
  <div class="vwrap" id="vwrap">
    <div class="vloading" id="vload"><div class="spin-ring"></div><span>Loadingâ€¦</span></div>
  </div>
</div>

<!-- Folder create modal -->
<div class="overlay" id="folder-modal">
  <div class="modal" style="max-width:340px">
    <h3>New Folder</h3>
    <input type="text" id="folder-name-in" placeholder="Folder nameâ€¦" maxlength="40"
      style="width:100%;padding:0.75rem 1rem;margin:1rem 0;background:var(--deep);border:1px solid var(--edge2);border-radius:10px;color:var(--text);font-size:0.9rem;font-family:'JetBrains Mono',monospace;outline:none;"
      onkeydown="if(event.key==='Enter') confirmCreateFolder()">
    <div style="display:flex;gap:0.75rem;justify-content:flex-end">
      <button class="btn-can" onclick="closeFolderModal()">Cancel</button>
      <button class="cta" style="width:auto;padding:0.55rem 1.5rem;font-size:0.85rem" onclick="confirmCreateFolder()">Create</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ”§ REPLACE THIS with your Cloudflare Worker URL after deploying
const WORKER_URL = 'https://dawn-hall-9929pdf-vault.p-c-9931534243.workers.dev';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S = {
  vaultCode: '', gistId: '', vaultName: 'My Vault',
  pdfs: [], folders: [], currentFolder: null, view: 'grid', q: ''
};
let pdfDoc = null, viewIdx = -1, curPage = 1, zScale = 1, delIdx = null;

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);

function fmtBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

function fmtDate(iso) {
  return new Date(iso).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
}

function toast(msg, type='', icon='â€¢') {
  const tc = $('toasts');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
  tc.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transform='translateX(18px)'; t.style.transition='all .3s'; setTimeout(()=>t.remove(),300); }, 3000);
}

function setStatus(msg, mode='ok') {
  $('st-dot').className = 'dot' + (mode==='spin'?' spin': mode==='bad'?' bad':'');
  $('st-msg').innerHTML = msg;
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  $(id).classList.add('active');
  // Close all modals when switching screens
  document.querySelectorAll('.overlay').forEach(m=>m.classList.remove('open'));
}

// â”€â”€ WORKER API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(endpoint, body={}) {
  const res = await fetch(WORKER_URL + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t) {
  ['new','open'].forEach(k => {
    $(`panel-${k}`).classList.toggle('on', k===t);
  });
  document.querySelectorAll('.tab').forEach((b,i) =>
    b.classList.toggle('on', (i===0)===(t==='new'))
  );
  $('err-box').style.display = 'none';
}

function showErr(msg) {
  const b = $('err-box');
  b.textContent = msg;
  b.style.display = 'block';
}

async function createVault() {
  const name = $('vault-name').value.trim() || 'My Vault';
  const btn = $('btn-create');
  btn.disabled = true; btn.textContent = 'Creating vaultâ€¦';
  $('err-box').style.display = 'none';
  try {
    const res = await api('/vault/create', { vaultName: name });
    S = { ...S, vaultCode: res.vaultCode, gistId: res.gistId, vaultName: res.vaultName, pdfs: [] };
    saveSession();
    $('show-code').textContent = res.vaultCode;
    $('code-modal').classList.add('open');
  } catch(e) {
    showErr(e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Create My Vault';
  }
}

async function openVault() {
  const code = $('vault-code-in').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'-').replace(/-+/g,'-');
  if (!code || code.length < 4) { showErr('Enter your vault code'); return; }
  const btn = $('btn-open');
  btn.disabled = true; btn.textContent = 'Openingâ€¦';
  $('err-box').style.display = 'none';
  try {
    const res = await api('/vault/open', { vaultCode: code });
    S = { ...S, vaultCode: code, gistId: res.gistId, vaultName: res.meta.vaultName || 'My Vault', pdfs: res.meta.pdfs || [], folders: res.meta.folders || [] };
    saveSession();
    enterVault();
  } catch(e) {
    showErr(e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Open Vault';
  }
}

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession() {
  sessionStorage.setItem('pv', JSON.stringify({
    vaultCode: S.vaultCode, gistId: S.gistId, vaultName: S.vaultName
  }));
}

function loadSession() {
  try { return JSON.parse(sessionStorage.getItem('pv') || 'null'); } catch { return null; }
}

function logout() {
  sessionStorage.removeItem('pv');
  S = { vaultCode:'', gistId:'', vaultName:'', pdfs:[], view:'grid', q:'' };
  pdfDoc = null;
  showScreen('auth');
}

// â”€â”€ ENTER VAULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterVault() {
  $('code-modal').classList.remove('open');
  $('pill-code').textContent = S.vaultCode.slice(0,9) + 'â€¦';
  $('vault-name-disp').textContent = S.vaultName;
  showScreen('vault');
  render();
  setStatus(`Synced Â· Vault <b>${S.vaultCode.slice(0,9)}</b>`);
  updateCount();
}

function updateCount() {
  $('st-count').textContent = S.pdfs.length + ' file' + (S.pdfs.length!==1?'s':'');
}

// â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSync() {
  setStatus('Syncingâ€¦', 'spin');
  $('sync-btn').textContent = 'âŸ³ Syncing';
  try {
    const res = await api('/vault/sync', { vaultCode: S.vaultCode, gistId: S.gistId });
    S.pdfs = res.meta.pdfs || [];
    S.folders = res.meta.folders || [];
    render();
    setStatus('Synced Â· ' + new Date().toLocaleTimeString());
    updateCount();
    toast('Vault synced', 'ok', 'âœ“');
  } catch(e) {
    setStatus('Sync failed', 'bad');
    toast('Sync failed: ' + e.message, 'bad', 'âœ—');
  } finally {
    $('sync-btn').textContent = 'âŸ³ Sync';
  }
}

async function pushMeta(pdfsOverride) {
  const meta = {
    vaultCode: S.vaultCode,
    vaultName: S.vaultName,
    version: '2.0',
    updated: new Date().toISOString(),
    folders: S.folders || [],
    pdfs: (pdfsOverride || S.pdfs).map(p => {
      const {_cache, ...clean} = p; return clean;
    })
  };
  await api('/vault/save-meta', { vaultCode: S.vaultCode, gistId: S.gistId, meta });
  return meta;
}

// â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('file-in').addEventListener('change', e => handleFiles([...e.target.files]));

const dz = $('dropzone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  const files = [...e.dataTransfer.files];
  if (files.length) handleFiles(files);
  else toast('No files detected', 'bad', 'âš ');
});

async function handleFiles(files) {
  for (const f of files) await uploadOne(f);
}

const CHUNK_SIZE = 7 * 1024 * 1024; // 7MB raw â†’ ~9.3MB base64 (GitHub Gist max ~10MB)
const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB limit

function fileIcon(name, type) {
  if (type === 'application/pdf' || name.endsWith('.pdf')) return 'ğŸ“„';
  if (type.startsWith('image/')) return 'ğŸ–¼ï¸';
  if (type.startsWith('video/')) return 'ğŸ¬';
  if (type.startsWith('audio/')) return 'ğŸµ';
  if (type.includes('zip') || type.includes('rar') || name.match(/\.(zip|rar|7z|tar|gz)$/i)) return 'ğŸ—œï¸';
  if (type.includes('word') || name.match(/\.(doc|docx)$/i)) return 'ğŸ“';
  if (type.includes('sheet') || name.match(/\.(xls|xlsx|csv)$/i)) return 'ğŸ“Š';
  if (type.includes('presentation') || name.match(/\.(ppt|pptx)$/i)) return 'ğŸ“‘';
  if (type.startsWith('text/') || name.match(/\.(txt|md|json|xml|html|css|js|ts|py|java|c|cpp)$/i)) return 'ğŸ“ƒ';
  return 'ğŸ“¦';
}

// Read a Blob slice as base64 â€” memory-safe, no full-file load
function readChunkAsB64(blob) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => {
      const raw = e.target.result;
      const comma = raw.indexOf(',');
      res(comma >= 0 ? raw.slice(comma + 1).replace(/[\s\r\n]/g, '') : raw.replace(/[\s\r\n]/g, ''));
    };
    r.onerror = rej;
    r.readAsDataURL(blob);
  });
}

async function uploadOne(file) {
  if (file.size > MAX_FILE_SIZE) {
    toast(`"${file.name}" exceeds 500 MB limit`, 'bad', 'âš ');
    return;
  }

  const pw = $('prog-wrap'), pf = $('prog-fill'), pt = $('prog-text');
  pw.style.display = 'block'; pf.style.width = '2%';

  const numChunks = Math.ceil(file.size / CHUNK_SIZE);
  const id = Date.now().toString(36) + Math.random().toString(36).slice(2, 5);

  try {
    setStatus('Uploadingâ€¦', 'spin');

    // Upload each chunk individually â€” slice file so only 7MB is in memory at a time
    for (let i = 0; i < numChunks; i++) {
      const start = i * CHUNK_SIZE;
      const end = Math.min(start + CHUNK_SIZE, file.size);
      const slice = file.slice(start, end);

      pt.textContent = numChunks > 1
        ? `Uploading part ${i + 1} of ${numChunks} â€” ${file.name}`
        : `Uploading ${file.name}â€¦`;

      const pct = 2 + Math.round(((i) / numChunks) * 88);
      pf.style.width = pct + '%';

      const chunkB64 = await readChunkAsB64(slice);

      await api('/vault/upload-chunk', {
        vaultCode: S.vaultCode, gistId: S.gistId,
        fileId: id, chunkIndex: i, data: chunkB64
      });
    }

    pf.style.width = '93%'; pt.textContent = 'Saving metadataâ€¦';

    // Count PDF pages (only for small PDFs to avoid memory pressure)
    let pages = null;
    if ((file.type === 'application/pdf' || file.name.endsWith('.pdf')) && file.size < 50 * 1024 * 1024) {
      try {
        const firstChunk = await readChunkAsB64(file.slice(0, Math.min(file.size, CHUNK_SIZE)));
        const ab = b64ToAB(firstChunk);
        const doc = await pdfjsLib.getDocument({ data: ab }).promise;
        pages = doc.numPages;
      } catch {}
    }

    const fileEntry = {
      id, name: file.name, size: file.size, type: file.type,
      pages, numChunks, folderId: S.currentFolder || null,
      uploaded: new Date().toISOString()
    };
    const newList = [fileEntry, ...S.pdfs];
    const metaObj = {
      vaultCode: S.vaultCode, vaultName: S.vaultName,
      version: '2.0', updated: new Date().toISOString(),
      folders: S.folders || [],
      pdfs: newList
    };
    await api('/vault/save-meta', { vaultCode: S.vaultCode, gistId: S.gistId, meta: metaObj });

    pf.style.width = '100%';
    S.pdfs = newList;

    render(); updateCount();
    setStatus(`Saved Â· ${S.pdfs.length} files`);
    toast(`"${file.name}" added to vault`, 'ok', 'âœ“');
    $('file-in').value = '';
  } catch (e) {
    setStatus('Upload failed', 'bad');
    toast('Upload failed: ' + e.message, 'bad', 'âœ—');
  } finally {
    setTimeout(() => { pw.style.display = 'none'; pf.style.width = '0%'; }, 1200);
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const grid = $('g'), empty = $('empty-state');
  const q = S.q.toLowerCase();

  // Update breadcrumb
  const bc = $('breadcrumb');
  if (S.currentFolder) {
    const folder = (S.folders || []).find(f => f.id === S.currentFolder);
    const fname = folder ? folder.name : 'Folder';
    bc.innerHTML = `<span onclick="goRoot()">ğŸ  Root</span><span class="sep"> / </span><span class="cur">ğŸ“ ${fname}</span>`;
  } else {
    bc.innerHTML = `<span class="cur">ğŸ  Root</span>`;
  }

  // Folders shown only in root when not searching
  const foldersToShow = (!S.currentFolder && !q) ? (S.folders || []) : [];

  // Files in current folder matching search
  const filesInFolder = (S.pdfs || []).filter(p =>
    (p.folderId || null) === S.currentFolder &&
    (!q || p.name.toLowerCase().includes(q))
  );

  if (!foldersToShow.length && !filesInFolder.length) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    empty.querySelector('h3').textContent = q ? 'No matches found' : 'Empty';
    empty.querySelector('p').textContent = q
      ? 'Try a different search term'
      : S.currentFolder ? 'Upload files into this folder' : 'Create a folder or upload files to get started';
    return;
  }
  empty.style.display = 'none';

  const folderHTML = foldersToShow.map((folder, i) => {
    const count = (S.pdfs || []).filter(p => p.folderId === folder.id).length;
    return `<div class="folder-card" style="animation-delay:${i * 0.04}s" onclick="openFolder('${folder.id}')">
      <div class="folder-icon">ğŸ“</div>
      <div>
        <div class="folder-name">${folder.name}</div>
        <div class="folder-meta">${count} file${count !== 1 ? 's' : ''}</div>
      </div>
      <button class="folder-del" onclick="event.stopPropagation();deleteFolder('${folder.id}')" title="Delete folder">âœ•</button>
    </div>`;
  }).join('');

  const fileHTML = filesInFolder.map((pdf, i) => `
    <div class="card" style="animation-delay:${(foldersToShow.length + i) * 0.04}s">
      <div class="thumb" id="th-${pdf.id}">${fileIcon(pdf.name, pdf.type || '')}</div>
      <div class="card-body">
        <div class="card-name" title="${pdf.name}">${pdf.name}</div>
        <div class="card-meta">${pdf.pages ? pdf.pages + ' pages Â· ' : ''}${fmtBytes(pdf.size)}</div>
        <div class="card-meta" style="margin-top:.15rem">${fmtDate(pdf.uploaded)}</div>
      </div>
      <div class="card-actions">
        <button class="act" onclick="openFile(${S.pdfs.indexOf(pdf)})">Open</button>
        <button class="act" onclick="dlPDF(${S.pdfs.indexOf(pdf)})">Save</button>
        <button class="act rm" onclick="promptDel(${S.pdfs.indexOf(pdf)})">Del</button>
      </div>
    </div>`).join('');

  grid.innerHTML = folderHTML + fileHTML;
}

function filterPDFs() { S.q = $('search-in').value; render(); }

function setView(v) {
  S.view = v;
  $('g').classList.toggle('list', v==='list');
  $('vbg').classList.toggle('on', v==='grid');
  $('vbl').classList.toggle('on', v==='list');
}

// â”€â”€ FOLDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFolder(id) { S.currentFolder = id; S.q = ''; $('search-in').value = ''; render(); }
function goRoot() { S.currentFolder = null; render(); }

function openFolderModal() {
  $('folder-name-in').value = '';
  $('folder-modal').classList.add('open');
  setTimeout(() => $('folder-name-in').focus(), 100);
}
function closeFolderModal() { $('folder-modal').classList.remove('open'); }

async function confirmCreateFolder() {
  const name = $('folder-name-in').value.trim();
  if (!name) return;
  closeFolderModal();
  const folder = { id: Date.now().toString(36) + Math.random().toString(36).slice(2,5), name, created: new Date().toISOString() };
  S.folders = [folder, ...(S.folders || [])];
  try {
    await pushMeta();
    toast(`Folder "${name}" created`, 'ok', 'ğŸ“');
  } catch(e) {
    toast('Failed to save folder: ' + e.message, 'bad', 'âœ—');
  }
  render();
}

async function deleteFolder(id) {
  const folder = (S.folders || []).find(f => f.id === id);
  if (!folder) return;
  const count = (S.pdfs || []).filter(p => p.folderId === id).length;
  if (count > 0 && !confirm(`"${folder.name}" contains ${count} file(s). Delete folder and move files to Root?`)) return;
  // Move files in this folder to root
  S.pdfs = S.pdfs.map(p => p.folderId === id ? {...p, folderId: null} : p);
  S.folders = S.folders.filter(f => f.id !== id);
  if (S.currentFolder === id) S.currentFolder = null;
  try {
    await pushMeta();
    toast(`Folder "${folder.name}" deleted`, '', 'ğŸ—‘');
  } catch(e) {
    toast('Failed to delete folder: ' + e.message, 'bad', 'âœ—');
  }
  render(); updateCount();
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function promptDel(i) {
  delIdx = i;
  $('del-name').textContent = S.pdfs[i].name;
  $('del-modal').classList.add('open');
}
function closeDelModal() { $('del-modal').classList.remove('open'); delIdx=null; }

async function confirmDel() {
  if (delIdx===null) return;
  const pdf = S.pdfs[delIdx];
  closeDelModal();
  setStatus('Deletingâ€¦', 'spin');
  try {
    const newList = S.pdfs.filter((_,i)=>i!==delIdx);
    const metaObj = { vaultCode:S.vaultCode, vaultName:S.vaultName, version:'1.0', updated:new Date().toISOString(), pdfs:newList };
    await api('/vault/delete-file', { vaultCode:S.vaultCode, gistId:S.gistId, fileId:pdf.id, meta:metaObj });
    S.pdfs = newList;
    render(); updateCount();
    setStatus(`Deleted Â· ${S.pdfs.length} files`);
    toast(`"${pdf.name}" deleted`, '', 'ğŸ—‘');
  } catch(e) {
    setStatus('Delete failed','bad');
    toast('Delete failed: '+e.message,'bad','âœ—');
  }
}

// â”€â”€ CHUNK REASSEMBLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns a Uint8Array of the full file bytes â€” never re-encodes to base64
async function fetchAllChunks(file) {
  if (file._cache) return file._cache;
  const numChunks = file.numChunks || 1;

  const arrays = [];
  let totalBytes = 0;
  for (let i = 0; i < numChunks; i++) {
    setStatus(`Loading part ${i + 1} of ${numChunks}â€¦`, 'spin');
    const res = await api('/vault/get-chunk', {
      vaultCode: S.vaultCode, gistId: S.gistId, fileId: file.id, chunkIndex: i
    });
    // Strip ALL whitespace GitHub may inject, then decode
    const clean = res.data.replace(/[^A-Za-z0-9+/=]/g, '');
    const bin = atob(clean);
    const arr = new Uint8Array(bin.length);
    for (let j = 0; j < bin.length; j++) arr[j] = bin.charCodeAt(j);
    arrays.push(arr);
    totalBytes += arr.length;
  }

  // Concat into single Uint8Array
  const combined = new Uint8Array(totalBytes);
  let offset = 0;
  for (const arr of arrays) { combined.set(arr, offset); offset += arr.length; }

  file._cache = combined;
  return combined;
}

// â”€â”€ VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openFile(idx) {
  const pdf = S.pdfs[idx];
  viewIdx = idx; curPage = 1; zScale = 1;
  $('v-title').textContent = pdf.name;
  $('z-label').textContent = '100%';
  $('vwrap').innerHTML = '';
  $('vwrap').appendChild(createLoading());
  showScreen('viewer');

  try {
    const bytes = await fetchAllChunks(pdf);  // Uint8Array
    const fileType = pdf.type || 'application/octet-stream';
    const isPDF = fileType === 'application/pdf' || pdf.name.toLowerCase().endsWith('.pdf');
    const isImage = fileType.startsWith('image/');
    const isText = fileType.startsWith('text/') || pdf.name.match(/\.(txt|md|json|xml|html|css|js|ts|py|sh|yaml|yml)$/i);

    if (isPDF) {
      pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
      $('pg-tot').textContent = pdfDoc.numPages;
      $('pg-in').value = 1; $('pg-in').max = pdfDoc.numPages;
      $('vwrap').innerHTML = '';
      await renderAllPages();
    } else if (isImage) {
      pdfDoc = null;
      const blob = new Blob([bytes], { type: fileType });
      const url = URL.createObjectURL(blob);
      $('pg-tot').textContent = 1; $('pg-in').value = 1; $('pg-in').max = 1;
      $('vwrap').innerHTML = `<div style="display:flex;justify-content:center;padding:2rem">
        <img src="${url}" style="max-width:100%;border-radius:8px;box-shadow:0 4px 24px rgba(0,0,0,0.5)" onload="URL.revokeObjectURL(this.src)">
      </div>`;
    } else if (isText) {
      pdfDoc = null;
      const text = new TextDecoder().decode(bytes);
      $('vwrap').innerHTML = `<pre style="padding:2rem;white-space:pre-wrap;word-break:break-word;font-family:'JetBrains Mono',monospace;font-size:0.82rem;color:var(--text);line-height:1.6">${text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>`;
    } else {
      pdfDoc = null;
      $('vwrap').innerHTML = `
        <div class="vloading" style="flex-direction:column;gap:1rem">
          <div style="font-size:3rem">${fileIcon(pdf.name, fileType)}</div>
          <div style="color:var(--sub);font-size:0.9rem">${pdf.name}</div>
          <div style="color:var(--sub);font-size:0.8rem">Preview not available for this file type</div>
          <button class="cta" style="width:auto;padding:0.6rem 1.5rem" onclick="dlPDF(${idx})">â¬‡ Download File</button>
        </div>`;
    }
    setStatus(`Viewing Â· ${pdf.name}`);
  } catch (e) {
    $('vwrap').innerHTML = `<div class="vloading" style="color:var(--danger)">Failed to load: ${e.message}</div>`;
  }
}

const openPDF = openFile;

function createLoading() {
  const d = document.createElement('div');
  d.className = 'vloading'; d.id = 'vload';
  d.innerHTML = '<div class="spin-ring"></div><span>Loading documentâ€¦</span>';
  return d;
}

async function renderAllPages() {
  const wrap = $('vwrap');
  const vw = Math.min(window.innerWidth - 32, 860);
  for (let i=1; i<=pdfDoc.numPages; i++) {
    const page = await pdfDoc.getPage(i);
    const vp0 = page.getViewport({scale:1});
    const scale = (vw/vp0.width) * zScale;
    const vp = page.getViewport({scale});
    const pw = document.createElement('div');
    pw.className = 'page-wrap'; pw.id = `pg-${i}`; pw.dataset.page = i;
    const canvas = document.createElement('canvas');
    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({canvasContext:canvas.getContext('2d'), viewport:vp}).promise;
    pw.appendChild(canvas); wrap.appendChild(pw);
  }

  // track page scroll
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        curPage = +e.target.dataset.page;
        $('pg-in').value = curPage;
        $('pg-prev').disabled = curPage<=1;
        $('pg-next').disabled = curPage>=pdfDoc.numPages;
      }
    });
  }, {threshold:0.4, root:wrap});
  wrap.querySelectorAll('.page-wrap').forEach(el=>obs.observe(el));
}

function pageStep(d) { goPage(curPage+d); }
function goPage(n) {
  n = parseInt(n);
  if (!pdfDoc||n<1||n>pdfDoc.numPages) return;
  const el = document.getElementById(`pg-${n}`);
  if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
}

async function zoom(d) {
  zScale = Math.max(0.5, Math.min(3, zScale+d));
  $('z-label').textContent = Math.round(zScale*100)+'%';
  if (pdfDoc) { $('vwrap').innerHTML=''; await renderAllPages(); }
}

function closeViewer() { pdfDoc=null; showScreen('vault'); }

// â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlPDF(idx) {
  const file = S.pdfs[idx];
  setStatus('Preparing downloadâ€¦', 'spin');
  try {
    const bytes = await fetchAllChunks(file);  // Uint8Array
    const mimeType = file.type || 'application/octet-stream';
    const blob = new Blob([bytes], { type: mimeType });
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(blob), download: file.name
    });
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 10000);
    setStatus('Downloaded Â· ' + file.name);
    toast('Download started', 'ok', 'â†“');
    // Don't keep very large files in memory cache
    if (file.size > 100 * 1024 * 1024) file._cache = null;
  } catch (e) {
    setStatus('Download failed', 'bad');
    toast('Download failed: ' + e.message, 'bad', 'âœ—');
  }
}
function dlCurrent() { if (viewIdx>=0) dlPDF(viewIdx); }

// â”€â”€ CODE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCodeModal() {
  $('show-code').textContent = S.vaultCode;
  $('code-modal').classList.add('open');
}
function copyCode() {
  navigator.clipboard.writeText(S.vaultCode).then(()=>toast('Vault code copied!','ok','ğŸ“‹'));
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function b64ToAB(b64) {
  const bin = atob(b64.replace(/[\s\r\n]/g, '')), bytes = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes.buffer;
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if ($('viewer').classList.contains('active')) {
    if (e.key==='ArrowRight'||e.key==='ArrowDown') pageStep(1);
    if (e.key==='ArrowLeft'||e.key==='ArrowUp') pageStep(-1);
    if (e.key==='Escape') closeViewer();
    if (e.key==='='||e.key==='+') zoom(0.2);
    if (e.key==='-') zoom(-0.2);
  }
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  // Check if worker URL is configured
  if (!WORKER_URL || WORKER_URL.includes('YOUR-WORKER')) {
    $('worker-notice').style.display = 'flex';
  }

  const sess = loadSession();
  if (sess?.vaultCode && sess?.gistId) {
    Object.assign(S, sess);
    setStatus('Loading vaultâ€¦','spin');
    try {
      const res = await api('/vault/sync', { vaultCode:S.vaultCode, gistId:S.gistId });
      S.pdfs = res.meta.pdfs || [];
      S.folders = res.meta.folders || [];
      S.vaultName = res.meta.vaultName || S.vaultName;
      enterVault();
    } catch { logout(); }
  }
})();
</script>
</body>
</html>
